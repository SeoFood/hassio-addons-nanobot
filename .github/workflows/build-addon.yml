name: Build Nanobot Add-on

on:
  pull_request:
    paths:
      - ".github/workflows/build-addon.yml"
      - "repository.yaml"
      - "nanobot/**"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/build-addon.yml"
      - "repository.yaml"
      - "nanobot/**"
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            build_from: ghcr.io/home-assistant/amd64-base-debian:bookworm
          - arch: aarch64
            platform: linux/arm64
            build_from: ghcr.io/home-assistant/aarch64-base-debian:bookworm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read add-on version
        id: addon
        shell: bash
        run: |
          set -euo pipefail
          version="$(awk -F': ' '/^version:/{gsub(/"/,"",$2); print $2; exit}' nanobot/config.yaml)"
          if [[ -z "${version}" ]]; then
            echo "Could not read add-on version from nanobot/config.yaml" >&2
            exit 1
          fi
          echo "version=${version}" >> "${GITHUB_OUTPUT}"

      - name: Build container image
        shell: bash
        run: |
          set -euo pipefail
          docker buildx build \
            --platform "${{ matrix.platform }}" \
            --file nanobot/Dockerfile \
            --build-arg BUILD_FROM="${{ matrix.build_from }}" \
            --build-arg BUILD_ARCH="${{ matrix.arch }}" \
            --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --build-arg BUILD_DESCRIPTION="Run the Nanobot AI agent as a Home Assistant add-on" \
            --build-arg BUILD_NAME="Nanobot" \
            --build-arg BUILD_REF="${GITHUB_SHA}" \
            --build-arg BUILD_REPOSITORY="${GITHUB_REPOSITORY}" \
            --build-arg BUILD_VERSION="${{ steps.addon.outputs.version }}" \
            --tag "nanobot-addon:${{ steps.addon.outputs.version }}-${{ matrix.arch }}" \
            --load \
            nanobot
